<!DOCTYPE HTML>
<html>
<head>
<title>Shooter</title>
<meta charset="utf-8">
<style type="text/css">
body {
	margin: 0;
	padding: 0;
	background-color: #000;
}
</style>
<script src = "Menu.js"></script>
<script src = "Level1.js"></script>
<script src = "Level2.js"></script>
<script src="//cdn.jsdelivr.net/phaser/2.6.2/phaser.min.js"
	type="text/javascript"></script>
</head>
<body>
	<audio id="myaudio" autoplay loop>
		<source src="assets/creosong.mp3" type="audio/mpeg">
	</audio>
	<script type="text/javascript">
		var game = new Phaser.Game(1500, 2000, Phaser.CANVAS, '' , false, false);								//added a few comments with context on changes
		
		game.global = {
			score : 0
		}
		var player;
		var enemy2;
		var enemy3;
		var enemy3Bullets;
		var starfield;
		var cursors;
		var bank;
		var shipTrail;
		var explosions;
		var playerDeath;
		var bullets;
		var fireButton;
		var bulletTimer = 0;
		var shields;
		var score = 0;
		var scoreText;
		var enemy2LaunchTimer;
		var enemy2Spacing = 1000;
		var enemy3LaunchTimer;
		var enemy3Launched = false;
		// Boss update
		var enemy3Spacing = 2500;
		var bossLaunchTimer;
		var bossLaunched = false;
		var bossSpacing = 20000;
		var bossBulletTimer = 0;
		var gameOver;
		var ACCLERATION = 600;
		var DRAG = 400;
		var MAXSPEED = 400;
		var music = document.getElementById("myaudio");
		music.volume = 0.5;
		var shot = new Audio('assets/sounds/laser7.mp3');
		var explode = new Audio('assets/sounds/explosion.wav');
		// Weapon
		var weapon;
		var weaponLaunchTimer;
		var weaponLaunched = false;
		
		game.state.add('Menu', Menu);
		game.state.add('Level1',Level1);
		game.state.add('Level2',Level2);
		game.state.start('Menu');
		
		function preload() {
			//  We need this because the assets are on github pages
			//  Remove the next 2 lines if running locally
			game.load.baseURL = 'https://ioniodi.github.io/Shooter/';
			game.load.crossOrigin = 'anonymous';
		}
		
		function render() {
			// for (var i = 0; i < enemy2.length; i++){
			//     game.debug.body(greenEnemies.children[i]);
			// }
			// game.debug.body(player);
		}
		
		function fireBullet() {
			switch (player.weaponLevel) {
				case 1:
				// To avoid them being allowed to fire too fast we set a time limit
				if (game.time.now > bulletTimer) {
					shot.play();
					var BULLET_SPEED = 400;
					var BULLET_SPACING = 250;
					//  Grab the first bullet we can from the pool
					var bullet = bullets.getFirstExists(false);
					
					if (bullet) {
						//  And fire it
						//  Make bullet come out of tip of ship with right angle
						var bulletOffset = 20 * Math.sin(game.math.degToRad(player.angle));
						bullet.reset(player.x + bulletOffset, player.y);
						bullet.angle = player.angle;
						game.physics.arcade.velocityFromAngle(bullet.angle, BULLET_SPEED, bullet.body.velocity);
						bullet.body.velocity.y += player.body.velocity.y;
						
						bulletTimer = game.time.now + BULLET_SPACING;
					}
				}
				break;
				case 2:
				if (game.time.now > bulletTimer) {
					shot.play();
					var BULLET_SPEED = 400;
					var BULLET_SPACING = 250;
					
					for (var i = 0; i < 2; i++) {
						var bullet = bullets.getFirstExists(false);
						if (bullet) {
							//  Make bullet come out of tip of ship with right angle
							var bulletOffset = 20 * Math.sin(game.math.degToRad(player.angle));
							bullet.reset(player.x, player.y + bulletOffset);
							//  "Spread" angle of bullets
							var spreadAngle;
							if (i === 0) spreadAngle = -10;
							if (i === 1) spreadAngle = 10;
							bullet.angle = player.angle + spreadAngle;
							game.physics.arcade.velocityFromAngle(spreadAngle, BULLET_SPEED, bullet.body.velocity);
							bullet.body.velocity.y += player.body.velocity.y;
						}
						bulletTimer = game.time.now + BULLET_SPACING;
					}
				}
				case 3:
				if (game.time.now > bulletTimer) {
					shot.play();
					var BULLET_SPEED = 400;
					var BULLET_SPACING = 300;
					
					for (var i = 0; i < 3; i++) {
						var bullet = bullets.getFirstExists(false);
						if (bullet) {
							//  Make bullet come out of tip of ship with right angle
							var bulletOffset = 20 * Math.sin(game.math.degToRad(player.angle));
							bullet.reset(player.x, player.y + bulletOffset);
							//  "Spread" angle of 1st and 3rd bullets
							var spreadAngle;
							if (i === 0) spreadAngle = -20;
							if (i === 1) spreadAngle = 0;
							if (i === 2) spreadAngle = 20;
							bullet.angle = player.angle + spreadAngle;
							game.physics.arcade.velocityFromAngle(spreadAngle, BULLET_SPEED, bullet.body.velocity);
							bullet.body.velocity.y += player.body.velocity.y;
						}
						bulletTimer = game.time.now + BULLET_SPACING;
					}
				}
				break;
				case 4:
				if (game.time.now > bulletTimer) {
					shot.play();
					var BULLET_SPEED = 400;
					var BULLET_SPACING = 200;
					
					for (var i = 0; i < 3; i++) {
						var bullet = bullets.getFirstExists(false);
						if (bullet) {
							//  Make bullet come out of tip of ship with right angle
							var bulletOffset = 20 * Math.sin(game.math.degToRad(player.angle));
							bullet.reset(player.x, player.y + bulletOffset);
							//  "Spread" angle of 1st and 3rd bullets
							var spreadAngle;
							if (i === 0) spreadAngle = -20;
							if (i === 1) spreadAngle = 0;
							if (i === 2) spreadAngle = 20;
							bullet.angle = player.angle + spreadAngle;
							game.physics.arcade.velocityFromAngle(spreadAngle, BULLET_SPEED, bullet.body.velocity);
							bullet.body.velocity.y += player.body.velocity.y;
						}
						bulletTimer = game.time.now + BULLET_SPACING;
					}
				}
			}
		}
		
		function launchEnemy2(){
			var ENEMY_SPEED = 300;
			var enemy = enemy2.getFirstExists(false);
			
			if(enemy){
				enemy.reset(game.width+20, game.rnd.integerInRange(0, game.height));
				enemy.body.velocity.x = -ENEMY_SPEED;
				enemy.body.velocity.y = game.rnd.integerInRange(-300, 300);
				enemy.body.drag.y = 50;
				
				enemy.trail.start(false, 800, 1);
				
				//  Update function for each enemy ship to update rotation etc
				enemy.update = function(){
					enemy.angle = -90 - game.math.radToDeg(Math.atan2(enemy.body.velocity.x, enemy.body.velocity.y));
					enemy.trail.x = enemy.x + 10;
					enemy.trail.y = enemy.y;
					
					//  Kill enemies once they go off screen
					if (enemy.x < -20) {
						enemy.kill();
					}
				}
				
			}
			//Send another enemy soon
			enemy2LaunchTimer = game.time.events.add(game.rnd.integerInRange(enemy2Spacing, enemy2Spacing + 1000), launchEnemy2);
		}
		
		function launchEnemy3() {
			var startingY = game.rnd.integerInRange(100, game.height - 100);
			var horizontalSpeed = 180;
			var spread = 60;
			var frequency = 70;
			var horizontalSpacing = 70;
			var numEnemiesInWave = 5;
			
			//  Launch wave
			for (var i =0; i < numEnemiesInWave; i++) {
				var enemy = enemy3.getFirstExists(false);
				if (enemy) {
					enemy.startingY = startingY;
					enemy.reset(game.width + horizontalSpacing * i, game.height / 2);
					enemy.body.velocity.x = -horizontalSpeed;
					//  Set up firing
					var bulletSpeed = 400;
					var firingDelay = 2000;
					enemy.bullets = 1;
					enemy.lastShot = 0;
					//  Update function for each enemy
					enemy.update = function(){
						//  Wave movement
						this.body.y = this.startingY + Math.sin((this.x) / frequency) * spread;
						//  Squish and rotate ship for illusion of "banking"
						bank = Math.cos((this.y + 60) / frequency)
						this.scale.y = 1 - Math.abs(bank) / 4;
						this.angle = - bank * 2
						//  Fire
						enemyBullet = enemy3Bullets.getFirstExists(false);
						if (enemyBullet && this.alive && this.bullets && this.x <  game.width * 7 / 8 &&
						    game.time.now > firingDelay + this.lastShot) {
							this.lastShot = game.time.now;
							this.bullets--;
							enemyBullet.reset(this.x - this.width / 2, this.y);
							enemyBullet.damageAmount = this.damageAmount;
							var angle = game.physics.arcade.moveToObject(enemyBullet, player, bulletSpeed);
							enemyBullet.angle = game.math.radToDeg(angle);
						}
						//  Kill enemies once they go off screen
						if (this.x < -200) {
							this.kill();
						}
					};
				}
			}
			
			// Send another wave soon
			enemy3LaunchTimer = game.time.events.add(game.rnd.integerInRange(enemy3Spacing, enemy3Spacing + 4000), launchEnemy3);
		}

		function launchBoss() {
			boss.reset(game.width + boss.width, game.height / 2);
			// Talvez mudar
			booster.start(false, 1000, 10);
			boss.health = 501;
			bossBulletTimer = game.time.now + 5000;
		}

		function addEnemyEmitterTrail(enemy) {
			var enemyTrail = game.add.emitter(enemy.x + 10, player.y, 100);
			enemyTrail.width = 10;
			enemyTrail.makeParticles('explosion', [1,2,3,4,5]);
			enemyTrail.setYSpeed(20, -20);
			enemyTrail.setRotation(50,-50);
			enemyTrail.setAlpha(0.4, 0, 800);
			enemyTrail.setScale(0.01, 0.1, 0.01, 0.1, 1000, Phaser.Easing.Quintic.Out);
			enemy.trail = enemyTrail;
		}
		
		function launchWeapon() {
			var WEAPON_SPEED = 150;
			var timeBetween = 10000;
			var diamond = weapon.getFirstExists(false);
			
			if (diamond && player.weaponLevel < 4) {
				diamond.reset(game.width + 20, game.rnd.integerInRange(0, game.height));
				diamond.body.velocity.x = - WEAPON_SPEED;
				diamond.update = function() {
					if (diamond.x < -20) {
						diamond.kill;
					}
				}
			}
			//Send another weapon soon
			weaponLaunchTimer = game.time.events.add(game.rnd.integerInRange(timeBetween, timeBetween + 4000), launchWeapon);	
		}
		
		function weaponCollide (player, weapon) {
			weapon.kill();
			if (player.weaponLevel < 4) {
				player.weaponLevel++;
			}
		}
		
		function shipCollide(player, enemy) {
			enemy.kill();
			explode.play();
			player.damage(enemy.damageAmount);
			shields.render();
			score += enemy.damageAmount * 10;
			scoreText.render();
			if (player.alive) {
				var explosion = explosions.getFirstExists(false);
				explosion.reset(player.body.x + player.body.halfWidth, player.body.y + player.body.halfHeight);
				explosion.alpha = 0.7;
				explosion.play('explosion', 30, false, true);
			} else {
				playerDeath.x = player.x;
				playerDeath.y = player.y;
				playerDeath.start(false, 1000, 10, 10);
			}
		}
		
		function hitEnemy(enemy, bullet) {
			var explosion = explosions.getFirstExists(false);
			explosion.reset(bullet.body.x + bullet.body.halfWidth, bullet.body.y + bullet.body.halfHeight);
			explosion.body.velocity.x = enemy.body.velocity.x;
			explosion.alpha = 0.7;
			explosion.play('explosion', 30, false, true);
			explode.play();
			if (enemy.finishOff && enemy.health < 5) {
				enemy.finishOff();
			} else {
				enemy.damage(enemy.damageAmount);
			}
			bullet.kill();
			// Increase score
			score += enemy.damageAmount * 10;
			scoreText.render();
	
			//  Pacing
			//  Enemies come quicker as score increases
			enemy2Spacing *= 0.9;
			//  Harder enemies come in after a score of 1000
			if (!enemy3Launched && score > 1000) {
				enemy3Launched = true;
				launchEnemy3();
				//  Slow first enemies down now that there are other enemies
				enemy2Spacing *= 2;
			}
			if (!weaponLaunched && score > 1500) {
				weaponLaunched = true;
				launchWeapon();
			}

			//  Launch boss
			if (!bossLaunched && score > 15000) {
				enemy2Spacing = 5000;
				enemy3Spacing = 12000;
				//  dramatic pause before boss
				game.time.events.add(2000, function(){
					bossLaunched = true;
					launchBoss();
				});
			}

			//  Weapon upgrade
			//if (score > 4000 && player.weaponLevel < 2) {
			//	player.weaponLevel = 2;
			//}
		}

		// Confirmar:
		//  Don't count a hit in the lower right and left quarants to aproximate better collisions
		function bossHitTest(boss, bullet) {
			if ((bullet.y > boss.y + boss.height / 5 &&
				bullet.x < boss.x) ||
				(bullet.y < boss.y - boss.height / 5 &&
				bullet.x < boss.x)) {
				return false;
			} else {
				return true;
			}
		}
		
		function enemyHitsPlayer (player, bullet) {
			bullet.kill();
			explode.play();
			player.damage(bullet.damageAmount);
			shields.render();
			if (player.alive) {
				var explosion = explosions.getFirstExists(false);
				explosion.reset(player.body.x + player.body.halfWidth, player.body.y + player.body.halfHeight);
				explosion.alpha = 0.7;
				explosion.play('explosion', 30, false, true);
			} else {
				playerDeath.x = player.x;
				playerDeath.y = player.y;
				playerDeath.start(false, 1000, 10, 10);
			}
		}
		
		function restart () {
			//  Reset the enemies
			enemy2.callAll('kill');
			game.time.events.remove(enemy2LaunchTimer);
			game.time.events.add(1000, launchEnemy2);
			enemy3.callAll('kill');
			enemy3Bullets.callAll('kill');
			game.time.events.remove(enemy3LaunchTimer);
			enemy3.callAll('kill');
			game.time.events.remove(enemy3LaunchTimer);
			boss.kill();
			booster.kill();
			game.time.events.remove(bossLaunchTimer);
			// Reset the weapons
			weapon.callAll('kill');
			game.time.events.remove(weaponLaunchTimer);
			//game.time.events.add(1000, launchWeapon);
			weaponLaunched = false;
			//  Revive the player
			player.weaponLevel = 1;
			player.revive();
			player.health = 100;
			shields.render();
			score = 0;
			scoreText.render();
			//  Hide the text
			gameOver.visible = false;
			//  Reset pacing
			enemy2Spacing = 1000;
			enemy3Launched = false;
			bossLaunched = false;
			//Music
			music.pause();
			music.currentTime = 0;
			music.play();
		}
		
	</script>
</body>
</html>
